---
import '../styles/global.css';
const { title = 'Chen Yang — Academic Homepage', description = 'Research, publications, projects, and contact' } = Astro.props;
---

<html lang="en" class="scroll-smooth bg-white dark:bg-slate-950">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.svg" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://github.com" />
    <link rel="dns-prefetch" href="https://github.com" />
    <link rel="preconnect" href="https://scholar.google.com" />
    <link rel="dns-prefetch" href="https://scholar.google.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;600;700&display=swap" rel="stylesheet" />
    <!-- LXGW WenKai webfont for Chinese Kaishu style -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css" />
    <meta name="color-scheme" content="light dark" />
    <link rel="preload" href="/cv.pdf" as="document" crossorigin>
    <!-- Global CSS is now included via Tailwind -->
    <style is:global>
      :root { --brand: 56 189 248; }
      html { font-family: Inter, "Noto Sans SC", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
      
      /* Force icons to have a size even if not loaded yet */
      [data-lucide], .lucide {
        display: inline-block;
        width: 1.25rem;
        height: 1.25rem;
        stroke-width: 2;
      }
    </style>
  </head>
  <body class="min-h-dvh bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 transition-colors duration-500">
    <header class="sticky top-0 z-50 backdrop-blur-md bg-white/80 dark:bg-slate-900/80 border-b border-slate-200/60 dark:border-slate-700/50 transition-colors duration-500">
      <nav class="mx-auto max-w-6xl px-5 h-16 flex items-center justify-between">
        <div class="flex items-center gap-8">
          <a href="/" class="font-bold tracking-tight text-xl hover:text-blue-600 transition-colors">Chen Yang</a>
          <div class="hidden md:flex items-center gap-6 text-sm font-semibold">
            <a href="/" class="text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Home</a>
            <a href="/#research" class="text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Research</a>
            <a href="/#background" class="text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Background</a>
            <a href="/#awards" class="text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Awards</a>
          </div>
        </div>
        
        <div class="flex items-center gap-6">
          <a href="/blog" class="text-sm font-bold text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Blog</a>
          <button id="theme-toggle" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:ring-2 ring-blue-400/50 transition-all focus:outline-none group" aria-label="Toggle Dark Mode">
            <span class="hidden dark:block">
              <i data-lucide="sun" class="w-5 h-5 text-yellow-500 group-hover:rotate-12 transition-transform"></i>
            </span>
            <span class="block dark:hidden">
              <i data-lucide="moon" class="w-5 h-5 text-slate-700 group-hover:-rotate-12 transition-transform"></i>
            </span>
          </button>
        </div>
      </nav>
    </header>

    <main class="mx-auto max-w-6xl px-5 py-14">
      <slot />
    </main>

    <!-- Clustrmaps Globe (lazy-loaded to avoid blocking page load) -->
    <div class="border-t border-slate-200/60 py-10">
      <div class="mx-auto max-w-6xl px-5">
        <div class="flex justify-center">
          <div id="clustrmaps-container" class="min-h-[300px] min-w-[300px]"></div>
        </div>
      </div>
    </div>

    <footer class="border-t border-slate-200/60 py-10">
      <div class="mx-auto max-w-6xl px-5 text-sm text-slate-500">
        © {new Date().getFullYear()} Chen Yang. All rights reserved.
      </div>
    </footer>

    <!-- Lucide Icons (async) -->
    <script async src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <script is:inline>
      // Initialize theme early to prevent flash
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
    
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.classList.remove('dark');
        document.documentElement.setAttribute('data-theme', 'light');
      }

      // Project filtering functionality
      const filterButtons = document.querySelectorAll('.filter-btn');
        const projectCards = document.querySelectorAll('.project-card');

        filterButtons.forEach(button => {
          button.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');

            // Update button states
            filterButtons.forEach(btn => {
              btn.classList.remove('bg-blue-600', 'text-white', 'active', 'shadow-md');
              btn.classList.add('bg-white', 'dark:bg-slate-800', 'text-gray-700', 'dark:text-gray-300', 'border-gray-200', 'dark:border-slate-700');
            });
            this.classList.remove('bg-white', 'dark:bg-slate-800', 'text-gray-700', 'dark:text-gray-300', 'border-gray-200', 'dark:border-slate-700');
            this.classList.add('bg-blue-600', 'text-white', 'active', 'shadow-md');

            // Filter projects
            projectCards.forEach(card => {
              const categories = card.getAttribute('data-category').split(' ');
              if (filter === 'all' || categories.includes(filter)) {
                card.style.display = 'flex';
              } else {
                card.style.display = 'none';
              }
            });
          });
        });

        // Background section tab functionality
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');

            // Update tab button states
            tabButtons.forEach(btn => {
              btn.classList.remove('text-blue-600', 'border-blue-600', 'active');
              btn.classList.add('text-gray-600', 'border-transparent');
            });
            this.classList.remove('text-gray-600', 'border-transparent');
            this.classList.add('text-blue-600', 'border-blue-600', 'active');

            // Show corresponding content
            tabContents.forEach(content => {
              if (content.id === `tab-${tabName}`) {
                content.style.display = 'block';
              } else {
                content.style.display = 'none';
              }
            });
          });
        });

        // Theme toggle logic
        const themeToggle = document.getElementById('theme-toggle');

        // Initialize Lucide icons
        const initLucide = (() => {
          let tries = 0;
          const maxTries = 50; // ~5s
          return function initLucideInner() {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
              return;
            }
            if (tries++ < maxTries) {
              setTimeout(initLucideInner, 100);
            }
          };
        })();

        document.addEventListener('DOMContentLoaded', initLucide);
        window.addEventListener('load', initLucide);

        // Re-initialize after theme toggle
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            const newTheme = isDark ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            setTimeout(initLucide, 10);
          });
        }

        // Lazy-load Clustrmaps after page load (prevents infinite loading on blocked networks)
        window.addEventListener('load', () => {
          const container = document.getElementById('clustrmaps-container');
          if (!container) return;
          // If already injected, skip
          if (document.getElementById('clstr_globe')) return;

          const s = document.createElement('script');
          s.type = 'text/javascript';
          s.id = 'clstr_globe';
          s.async = true;
          s.src = '//clustrmaps.com/globe.js?d=pV71LnC71IrfEBQZBzoLe3YrtnJhQ5qtWT6to28Cu4o&w=300&h=300';
          container.appendChild(s);
        });

        // Scroll Reveal Observer
        const observerOptions = {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        };

        const revealObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('active');
              revealObserver.unobserve(entry.target);
            }
          });
        }, observerOptions);

        document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));
    </script>
  </body>
</html> 